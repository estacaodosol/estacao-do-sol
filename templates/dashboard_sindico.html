{% extends 'base.html' %}

{% block titulo %}Dashboard do Síndico{% endblock %}

{% block conteudo %}
<div class="container py-4">

    <h2 class="mb-4">Dashboard do Síndico</h2>

    <!-- Botão Voltar -->
    <a href="{{ url_for('historico') }}" class="btn btn-secondary mb-4">
        <i class="fas fa-arrow-left"></i> Voltar
    </a>

    <div class="row g-4">
        <!-- Gráfico de Barras -->
        <div class="col-12 col-md-6">
            <h5 class="text-center">Pedidos por Serviço (Quantidade)</h5>
            <div class="grafico-wrapper">
                <canvas id="graficoServicos"></canvas>
            </div>
        </div>

        <!-- Gráfico de Pizza -->
        <div class="col-12 col-md-6">
            <h5 class="text-center">Distribuição de Pedidos por Serviço (Percentual)</h5>
            <div class="grafico-wrapper">
                <canvas id="graficoPizza"></canvas>
            </div>
        </div>
    </div>

</div>

<style>
.grafico-wrapper {
    width: 100%;
    height: 250px; /* altura menor e mais agradável */
}
@media (min-width: 768px) { .grafico-wrapper { height: 300px; } }
@media (min-width: 1200px) { .grafico-wrapper { height: 350px; } }
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<script>
const labels = {{ servicos_count.keys()|list|tojson | default('[]') }};
const dataValores = {{ servicos_count.values()|list|tojson | default('[]') }};
const total = dataValores.reduce((a,b) => a + b, 0);

// Gráfico de Barras
const ctxBar = document.getElementById('graficoServicos').getContext('2d');
new Chart(ctxBar, {
    type: 'bar',
    data: { labels: labels, datasets: [{ label: 'Pedidos por Serviço', data: dataValores, backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e'] }] },
    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
});

// Gráfico de Pizza com percentuais dentro das fatias
const ctxPizza = document.getElementById('graficoPizza').getContext('2d');
new Chart(ctxPizza, {
    type: 'pie',
    data: { labels: labels, datasets: [{ label: 'Percentual de Pedidos', data: dataValores, backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e'] }] },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom' },
            datalabels: {
                color: '#fff',
                formatter: (value, ctx) => {
                    let percentage = ((value / total) * 100).toFixed(1);
                    return `${percentage}%`;
                },
                font: { weight: 'bold', size: 14 }
            }
        }
    },
    plugins: [ChartDataLabels]
});
</script>
{% endblock %}
