{% extends 'base.html' %}
{% block titulo %}Histórico de Solicitações{% endblock %}

{% block conteudo %}
<div class="container mt-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start mb-4 gap-2">
    <h2>Histórico de Solicitações</h2>
    <a href="{{ url_for('logout') }}" class="btn btn-danger">Sair</a>
  </div>

  <!-- Filtros -->
  <form method="GET" class="row g-2 mb-4">
    <div class="col-12 col-md-2">
      <input type="text" name="nome" class="form-control" placeholder="Nome" value="{{ request.args.get('nome', '') }}">
    </div>
    <div class="col-12 col-md-2">
      <select name="servico" class="form-select">
        <option value="">Todos os serviços</option>
        {% for s in servicos_disponiveis %}
          <option value="{{ s }}" {% if request.args.get('servico') == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-2">
      <select name="status" class="form-select">
        <option value="">Todos os status</option>
        {% for st in ['Pendente','Em andamento','Concluído','Cancelado','Não autorizado'] %}
          <option value="{{ st }}" {% if request.args.get('status') == st %}selected{% endif %}>{{ st }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-2">
      <input type="date" name="data_inicial" class="form-control" value="{{ request.args.get('data_inicial', '') }}">
    </div>
    <div class="col-12 col-md-2">
      <input type="date" name="data_final" class="form-control" value="{{ request.args.get('data_final', '') }}">
    </div>
    <div class="col-6 col-md-1">
      <button type="submit" class="btn btn-primary w-100">Filtrar</button>
    </div>
    <div class="col-6 col-md-1">
      <a href="{{ url_for('historico') }}" class="btn btn-secondary w-100">Limpar</a>
    </div>
  </form>

  {% if session.tipo == 'sindico' %}
    <a href="{{ url_for('gerenciar_sindico') }}" class="btn btn-outline-primary mb-3">Gerenciar Síndico</a>
  {% endif %}

  {% if solicitacoes %}
    <div class="table-responsive">
      <table class="table table-bordered table-striped">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Data</th>
            <th>Usuário</th>
            <th>Nome</th>
            <th>Serviço</th>
            <th>Descrição</th>
            <th>Status</th>
            <th>Observação</th>
          </tr>
        </thead>
        <tbody>
          {% for s in solicitacoes %}
            <tr>
              <td>{{ s['id'] }}</td>
              <td>{{ s['data'] }}</td>
              <td>{{ s['usuario'] }}</td>
              <td>{{ s['nome'] }}</td>
              <td>{{ s['servico'] }}</td>
              <td>{{ s['descricao'] }}</td>
              <td>
                {% if session.tipo == 'sindico' %}
                  <form action="{{ url_for('alterar_status') }}" method="POST" class="d-flex flex-wrap gap-1">
                    <input type="hidden" name="id" value="{{ s['id'] }}">
                    <select name="status" class="form-select form-select-sm">
                      {% for st in ['Pendente','Em andamento','Concluído','Cancelado','Não autorizado'] %}
                        <option value="{{ st }}" {% if s['status'] == st %}selected{% endif %}>{{ st }}</option>
                      {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-sm btn-primary">Atualizar</button>
                  </form>
                {% else %}
                  {{ s['status'] }}
                {% endif %}
              </td>
              <td>{{ s['observacao'] or '-' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-warning">Nenhuma solicitação encontrada.</div>
  {% endif %}
</div>
{% endblock %}
